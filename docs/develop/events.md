# 事件

被动技能、装备、状态/出战状态、召唤物、支援牌都可以监听一些事件，并做出响应。

## 事件列表

### 阶段性事件

| 事件名          | 含义（对应卡牌描述） |
| --------------- | -------------------- |
| `onBattleBegin` | 战斗开始时           |
| `onRollPhase`   | 【同步】掷骰阶段时   |
| `onActionPhase` | 行动阶段开始时       |
| `onEndPhase`    | 结束阶段时           |

双方场上的所有实体都会同时接收到上述事件。

### 行动事件

| 事件名            | 含义（对应卡牌描述）                                |
| ----------------- | --------------------------------------------------- |
| `onBeforeAction`  | 行动前                                              |
| `onBeforeUseDice` | 【同步】少/多花费骰子 <br> 或将切换角色视为快速行动 |
| `onUseSkill`      | 使用技能后                                          |
| `onSwitchActive`  | 切换出战角色后                                      |
| `onPlayCard`      | 打出手牌后                                          |
| `onDeclareEnd`    | 宣布结束后                                          |
| `onAction`        | 行动后                                              |

默认情况下，只有当前行动轮玩家场上的实体会收到这些事件，除非(unless)对面场上某个实体的 `listenTo` 属性为 `all`。

### 伤害计算事件

| 事件名                    | 含义（对应卡牌描述）                      | 默认接收方       |
| ------------------------- | ----------------------------------------- | ---------------- |
| `onEarlyBeforeDealDamage` | 【同步】\* 时，造成的伤害变为 \* 元素伤害 | 伤害来源场或角色 |
| `onBeforeDealDamage`      | 【同步】造成伤害时，增加/抵消 \* 点伤害   | 伤害来源场或角色 |
| `onBeforeSkillDamage`     | 【同步】使用 \* 技能时，增加 \* 点伤害    | 伤害来源角色     |
| `onBeforeDamaged`         | 【同步】受到伤害时，增加/抵消 \* 点伤害   | 伤害目标角色     |

伤害可以有来源和目标。伤害来源指：

- 角色技能；
- 召唤物、状态、出战状态等；
- 某一伤害引发元素反应后，造成的级联伤害。

伤害目标指角色。

对于前三者而言：

- 如果接收事件实体的 `listenTo` 为 `master`：则只有被附着的角色的角色技能造成的伤害（不含元素反应）会被收到。
- 如果接收事件实体的 `listenTo` 为 `my`：则我方所有来源的伤害（上述三种）都会被收到。
- 否则（为 `all`）：双方所有来源的伤害都会被收到。

对于 `onBeforeDamaged`：

- 目标角色上附着的状态、技能等；
- 目标角色场上的所有 `listenTo` 为 `my` 的实体；
- 所有 `listenTo` 为 `all` 的实体。

### 通用偶发事件

| 事件名                | 含义（对应卡牌描述）         | 默认接收方       |
| --------------------- | ---------------------------- | ---------------- |
| `onDealDamage`        | 造成伤害后                   | 伤害来源场或角色 |
| `onDamaged`           | 受到伤害后                   | 伤害目标角色     |
| `onElementalReaction` | 引发元素反应后               | 无（全局）       |
| `onBeforeDefeated`    | 【同步】被击倒时，免于被击倒 | 被击倒角色       |
| `onDefeated`          | 被击倒后                     | 被击倒角色       |
| `onRevive`            | （描述中未出现）角色复苏后   | 被复苏角色       |

`onElementalReaction` 会被场上所有实体接收；除此之外的接收范围如表格所示（可藉由 `listenTo` 更改）。

「坚定之岩」的“造成伤害后”触发时机为“使用技能后”，可考虑修改其卡牌描述。

### 特殊事件

| 事件名      | 含义（对应卡牌描述） | 默认接收方 |
| ----------- | -------------------- | ---------- |
| `onEnter`   | 入场后               | 仅该实体   |
| `onDispose` | 【同步】退场时       | 仅该实体   |

- 除非 `listenTo` 为 `all`，否则上述两事件仅会被正在入场/退场的实体本身接收。

## 同步事件

大部分事件的处理函数是**异步**的，因为它们可能引发用户操作如掷骰、选牌、选角色等。但诸如增减骰、伤害计算等事件，其处理绝对不会引发用户操作，因此它们可以且必须被强制收束为同步操作。

同步事件的处理函数中使用异步（`async`）后会抛出错误。

## 事件引发与事件处理

对于同步事件，事件引发后会立即广播给所有可以监听此事件的实体，然后按 _规定顺序_ 执行事件处理函数。

对于异步事件，事件引发后会先记录在内部事件队列中，随后通过 `doEvent` 函数“手动”引发它们。

### `doEvent` 时机

- 每次引发阶段性事件后，执行 `doEvent`。
- 在执行完技能后，引发 `onUseSkill` 之前，执行 `doEvent`（i.e. 技能中途引发的事件延迟到技能执行完毕、使用技能后之间的时间点处理）
- 每执行完一个实体的事件处理函数后，都要再次 `doEvent`。

### `doEvent` 流程

1. 事件按如下顺序排序（暂定）：

- `onSwitchActive`；
- `onDefeated` 或 `onRevive`；
- 其它事件，按照引发顺序原样保留。

2. 对于上述排序后队列中的每个事件， 以 _规定顺序_ 执行各个实体的事件处理函数。每执行完一个事件处理函数，应当执行 `doEvent` 以处理新引发的级联事件。
